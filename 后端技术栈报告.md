# Forsion AI Studio 后端技术栈报告

## 📋 项目概述

Forsion AI Studio 是一个基于 Node.js 的 AI 聊天应用后端服务，提供用户认证、模型管理、API 代理、积分系统等核心功能。

---

## 🛠️ 核心技术栈

### 运行时环境
- **Node.js**: v18 (Alpine Linux)
- **运行模式**: ES Modules (ESM)
- **包管理器**: npm

### 编程语言
- **TypeScript**: v5.3.3
  - 目标版本: ES2022
  - 模块系统: NodeNext
  - 严格模式: 启用
  - 支持类型声明和源码映射

### Web 框架
- **Express.js**: v4.18.2
  - RESTful API 架构
  - 中间件支持
  - 路由管理
  - 静态文件服务

---

## 🗄️ 数据库

### 数据库系统
- **MySQL**: 通过 `mysql2` v3.6.5 连接
  - 连接池管理 (最大 10 个连接)
  - 支持 Keep-Alive
  - 异步/等待模式

### 数据库表结构
项目包含以下核心数据表：

1. **users** - 用户表
   - 用户基本信息、角色、状态管理
   - 支持权限控制和每日请求限制

2. **user_settings** - 用户设置表
   - 主题配置、自定义模型、外部 API 配置

3. **global_models** - 全局模型表
   - AI 模型配置、API 密钥、启用状态

4. **api_usage_logs** - API 使用日志表
   - 请求记录、Token 统计、成功率追踪

5. **global_settings** - 全局设置表
   - 系统级配置存储

6. **invite_codes** - 邀请码表
   - 邀请码管理、使用次数限制、过期时间

7. **user_credits** - 用户积分表
   - 积分余额、累计获得/消费记录

8. **credit_transactions** - 积分交易表
   - 交易历史、余额变更记录

9. **credit_pricing** - 积分定价表
   - 模型定价配置、Token 转换率

---

## 🔐 认证与安全

### 认证机制
- **JWT (JSON Web Token)**: `jsonwebtoken` v9.0.2
  - Token 生成和验证
  - 默认过期时间: 7 天
  - Bearer Token 认证方式

### 密码安全
- **bcryptjs**: v2.4.3
  - 密码哈希加密
  - 安全密码存储

### 中间件
- `authMiddleware`: 必需认证中间件
- `adminMiddleware`: 管理员权限验证
- `optionalAuthMiddleware`: 可选认证中间件

---

## 📦 核心依赖

### HTTP 与网络
- **cors**: v2.8.5 - 跨域资源共享
- **dotenv**: v16.3.1 - 环境变量管理

### 文件处理
- **multer**: v1.4.5-lts.1 - 文件上传处理
- **pdf-parse**: v1.1.1 - PDF 文件解析
- **mammoth**: v1.6.0 - Word 文档 (.docx) 解析

### 工具库
- **uuid**: v9.0.1 - 唯一标识符生成

---

## 🏗️ 项目架构

### 目录结构
```
server-node/
├── src/
│   ├── config/          # 配置文件
│   │   └── database.ts   # 数据库连接配置
│   ├── db/              # 数据库相关
│   │   ├── migrate.ts    # 数据库迁移
│   │   └── seed.ts      # 数据种子
│   ├── middleware/      # 中间件
│   │   └── auth.ts      # 认证中间件
│   ├── routes/          # 路由定义
│   │   ├── auth.ts      # 认证路由
│   │   ├── users.ts     # 用户管理
│   │   ├── models.ts    # 模型管理
│   │   ├── chat.ts      # 聊天 API
│   │   ├── files.ts     # 文件处理
│   │   ├── usage.ts     # 使用统计
│   │   ├── inviteCodes.ts # 邀请码管理
│   │   ├── credits.ts   # 积分管理
│   │   └── creditPricing.ts # 积分定价
│   ├── services/        # 业务逻辑层
│   │   ├── userService.ts
│   │   ├── modelService.ts
│   │   ├── creditService.ts
│   │   ├── creditPricingService.ts
│   │   ├── inviteCodeService.ts
│   │   ├── usageService.ts
│   │   └── settingsService.ts
│   ├── types/           # TypeScript 类型定义
│   │   └── index.ts
│   └── index.ts         # 应用入口
├── Dockerfile           # Docker 构建配置
├── tsconfig.json        # TypeScript 配置
└── package.json         # 项目依赖
```

### 架构模式
- **分层架构**: 路由层 → 服务层 → 数据访问层
- **RESTful API**: 标准 REST 接口设计
- **中间件模式**: 认证、错误处理等通过中间件实现

---

## 🚀 API 路由

### 认证相关 (`/api/auth`)
- `POST /api/auth/login` - 用户登录
- `POST /api/auth/register` - 用户注册（需邀请码）
- `GET /api/auth/me` - 获取当前用户信息
- `PUT /api/auth/password` - 修改密码

### 用户管理 (`/api`)
- 用户 CRUD 操作
- 用户设置管理

### 模型管理 (`/api`)
- 全局模型配置
- 模型启用/禁用
- API 密钥管理

### 聊天 API (`/api/chat`)
- `POST /api/chat/completions` - 聊天补全（支持流式响应）
  - 支持 SSE (Server-Sent Events) 流式传输
  - 自动积分扣除
  - Token 使用统计

### 文件处理 (`/api`)
- 文件上传
- PDF/Word 文档解析

### 使用统计 (`/api`)
- API 使用日志查询
- 统计数据聚合（按模型、日期、用户）

### 邀请码管理 (`/api/admin/invite-codes`)
- 创建、查询、更新、删除邀请码
- 使用次数限制
- 过期时间管理

### 积分系统 (`/api`)
- 积分余额查询
- 积分交易记录
- 积分定价配置

---

## 🔄 核心功能特性

### 1. 流式响应支持
- 支持 OpenAI 兼容的流式 API 响应
- Server-Sent Events (SSE) 实现
- 实时 Token 使用统计

### 2. 积分系统
- 基于 Token 使用量的动态计费
- 支持多种交易类型（初始、使用、退款、奖励、调整）
- 实时余额检查和扣除

### 3. 邀请码系统
- 邀请码注册机制
- 使用次数限制
- 过期时间控制
- 初始积分分配

### 4. 使用统计
- 详细的 API 调用日志
- 按模型、日期、用户聚合统计
- 成功率追踪
- Token 使用量统计

### 5. 多模型支持
- 支持多个 AI 模型提供商
- 可配置的 API 密钥和基础 URL
- 模型启用/禁用控制

---

## 🛠️ 开发工具

### 开发依赖
- **TypeScript**: v5.3.3 - 类型系统
- **tsx**: v4.6.2 - TypeScript 执行器（开发模式）
- **@types/*** - TypeScript 类型定义包

### 构建与运行
```bash
# 开发模式（热重载）
npm run dev

# 构建生产版本
npm run build

# 运行生产版本
npm start

# 数据库迁移
npm run db:migrate

# 数据种子
npm run db:seed
```

---

## 🐳 容器化部署

### Docker 配置
- **基础镜像**: `node:18-alpine`
- **多阶段构建**: 构建阶段 + 生产阶段
- **非 root 用户**: 安全运行（nodejs 用户）
- **健康检查**: 内置健康检查端点

### 环境变量
- `PORT`: 服务端口（默认 3001）
- `NODE_ENV`: 运行环境
- `DB_HOST`, `DB_PORT`, `DB_USER`, `DB_PASSWORD`, `DB_NAME`: 数据库配置
- `JWT_SECRET`: JWT 密钥
- `JWT_EXPIRES_IN`: Token 过期时间
- `ADMIN_USERNAME`, `ADMIN_PASSWORD`: 默认管理员账号

---

## 📊 性能特性

### 数据库优化
- 连接池管理（最大 10 个连接）
- 数据库索引优化
- 查询参数化（防止 SQL 注入）

### API 优化
- 请求体大小限制: 50MB
- CORS 配置支持多源
- 流式响应减少内存占用

### 安全特性
- JWT Token 认证
- 密码哈希加密
- SQL 注入防护
- 非 root 容器运行

---

## 🔌 外部集成

### AI API 代理
- 支持 OpenAI 兼容 API
- 可配置多个模型提供商
- 自动 API 密钥管理
- 错误处理和重试机制

### 文件处理
- PDF 文档解析
- Word 文档 (.docx) 解析
- 文件上传处理

---

## 📝 代码质量

### TypeScript 配置
- 严格模式启用
- ES2022 目标版本
- 完整的类型声明
- 源码映射支持

### 代码组织
- 模块化设计
- 服务层分离
- 类型安全
- 错误处理完善

---

## 🚦 启动流程

1. **环境变量加载** - 加载 `.env` 配置
2. **数据库连接测试** - 验证数据库连接
3. **确保管理员存在** - 自动创建默认管理员
4. **确保内置模型** - 初始化默认模型配置
5. **修复数据问题** - 修复使用日志中的空值
6. **启动服务器** - 监听指定端口

---

## 📈 监控与日志

### 日志记录
- API 使用日志（成功/失败）
- Token 使用统计
- 错误信息记录
- 数据库操作日志

### 健康检查
- `/api/health` - 服务健康状态端点

---

## 🔮 技术亮点

1. **ESM 模块系统**: 使用现代 ES Modules，支持 Tree Shaking
2. **流式响应**: 实现高效的 SSE 流式传输
3. **积分系统**: 完整的积分管理和计费系统
4. **多模型支持**: 灵活的模型配置和管理
5. **类型安全**: 完整的 TypeScript 类型定义
6. **容器化**: 生产就绪的 Docker 配置
7. **安全性**: 多层安全防护机制

---

## 📚 相关文档

- `STARTUP_GUIDE.md` - 启动指南
- `TROUBLESHOOTING.md` - 故障排除指南
- `env.example` - 环境变量示例

---

## 🎯 总结

Forsion AI Studio 后端采用现代化的 Node.js + TypeScript + Express 技术栈，结合 MySQL 数据库，实现了完整的 AI 聊天应用后端服务。项目架构清晰，代码组织良好，支持流式响应、积分系统、多模型管理等高级功能，具备良好的扩展性和可维护性。

---

**报告生成时间**: 2024年
**项目版本**: 1.0.0




